{% extends 'base.html.twig' %}
{% block title %}Admin — Réservations{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    
    .admin-wrap, .admin-wrap *{ font-family:'Poppins',sans-serif; color:#000; }

    .admin-wrap{ max-width:1100px; margin:40px auto; padding:0 20px; }
    .admin-head{ display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap; }
    .admin-head h1{ margin:0; font-size:26px; font-weight:700; letter-spacing:.2px; }

    
    .search-wrap{ flex:1; display:flex; justify-content:flex-end; min-width:340px; }
    .search{
      width:100%; max-width:620px; display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid #000; background:#fff; border-radius:0;
    }
    .search svg{ flex:0 0 auto; opacity:.85 }
    .search input{
      flex:1; min-width:140px; border:none; outline:none; background:transparent;
      font-size:14px; font-weight:500; padding:2px 0;
    }
    .search .count{
      display:none; padding:2px 8px; font-size:12px; line-height:1;
      border:1px solid #000; background:#fff;
    }
    .search .clear{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border:1px solid #000; background:#000; color:#fff;
      cursor:pointer; border-radius:0;
    }

   
    .table-wrap{ margin-top:18px; overflow-x:auto; }
    table.admin{
      width:100%; border-collapse:collapse; border:1px solid #000;
    }
    .admin thead th{
      text-align:left; padding:12px; border-bottom:1px solid #000; font-size:13px; font-weight:600;
    }
    .admin tbody td{
      padding:12px; border-top:1px solid #000; font-size:13px; vertical-align:top;
    }

    
    .btn-black{
      appearance:none; border:1px solid #000; background:#000; color:#fff;
      padding:10px 14px; border-radius:0; font-weight:600; line-height:1; cursor:pointer;
    }
    .btn-black:hover{ opacity:.9; }
    .btn-black:active{ opacity:.85; }

    
    .st-ok{ color:#166534; }      
    .st-warn{ color:#92400e; }    
    .st-exp{ color:#991b1b; }     

    
    .flash{ padding:.6rem 1rem; border:1px solid #000; border-radius:0; }
    .flash.ok{ background:#e7ffe7; }
    .flash.err{ background:#ffe7e7; }

   
    .list-plain{ margin:0; padding-left:16px; }
  </style>
{% endblock %}

{% block body %}
{% set tz = 'Europe/Paris' %}
{% set nowLocal = now ?? date(null, tz) %}

<div class="admin-wrap">
  <div class="admin-head">
    <h1>Réservations</h1>

    
    <div class="search-wrap">
      <div class="search" id="searchBar">
       
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="7"></circle>
          <path d="M21 21l-3.2-3.2"></path>
        </svg>

        
        <input id="searchInput" type="search" inputmode="search" autocomplete="off" spellcheck="false"
               placeholder="Rechercher une référence… (ex. CMD-12345)"
               aria-label="Rechercher une réservation par numéro de référence" />

       
        <span id="searchCount" class="count" aria-live="polite"></span>

        
        <button id="clearSearchBtn" type="button" class="clear" title="Effacer" aria-label="Effacer la recherche">✕</button>
      </div>
    </div>
  </div>

 
  {% for m in app.flashes('success') %}
    <div class="flash ok" style="margin:.75rem 0;">{{ m }}</div>
  {% endfor %}
  {% for m in app.flashes('error') %}
    <div class="flash err" style="margin:.75rem 0;">{{ m }}</div>
  {% endfor %}

  <div class="table-wrap">
    <table id="reservationsTable" class="admin">
      <thead>
        <tr>
          <th>Cmd</th>
          <th>Client</th>
          <th>Opération</th>
          <th>Créée</th>
          <th>Échéance</th>
          <th>Statut</th>
          <th>Détail</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          {% set deadlineU = r.pickupDeadline|date('U', tz) %}
          {% set nowU = nowLocal|date('U', tz) %}
          {% set expired = (r.status == 'pending' and deadlineU <= nowU) %}

          <tr data-order="{{ r.orderCode|lower }}">
            <td style="font-weight:600;">{{ r.orderCode }}</td>
            <td>{{ r.firstName }} {{ r.lastName }}</td>
            <td>{% if r.operation == 'buy' %}Achat{% else %}Vente{% endif %}</td>
            <td>{{ r.createdAt|date('Y-m-d H:i', tz) }}</td>
            <td>{{ r.pickupDeadline|date('Y-m-d H:i', tz) }}</td>
            <td>
              {% if r.status == 'completed' %}
                <span class="st-ok">Transaction passée</span>
              {% elseif expired %}
                <span class="st-exp">Expirée</span>
              {% else %}
                {% set seconds = (deadlineU - nowU) %}
                {% set totalMins = (seconds / 60)|round(0, 'floor') %}
                {% set hours = (totalMins // 60) %}
                {% set mins  = (totalMins % 60) %}
                <span class="st-warn">
                  {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}min restantes
                </span>
              {% endif %}
            </td>
            <td>
              <ul class="list-plain">
                {% for it in r.items %}
                  <li>
                    {{ it.currency }} — EUR: {{ it.amountEuro ?? '-' }}, Local: {{ it.amountLocal ?? '-' }}
                    (B: {{ it.rateBuy|number_format(4,'.',' ') }}, S: {{ it.rateSell|number_format(4,'.',' ') }})
                  </li>
                {% endfor %}
              </ul>
            </td>
            <td>
              {% if r.status != 'completed' %}
                <form method="post" action="{{ path('admin_reservation_confirm', {id: r.id, mode: 'admin'}) }}">
                  <button class="btn-black" type="submit">Confirmer retrait</button>
                </form>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr class="row-empty"><td colspan="8" style="color:#6b7280;">Aucune réservation.</td></tr>
        {% endfor %}
        <tr id="noMatchRow" style="display:none;">
          <td colspan="8" style="color:#6b7280;">Aucune réservation ne correspond à cette référence.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    (function(){
      function ready(fn){document.readyState!=='loading'?fn():document.addEventListener('DOMContentLoaded',fn);}
      ready(function(){
        var input=document.getElementById('searchInput');
        var clearBtn=document.getElementById('clearSearchBtn');
        var countBadge=document.getElementById('searchCount');
        var tbody=document.querySelector('#reservationsTable tbody');
        var noMatchRow=document.getElementById('noMatchRow');

        function getRows(){
          return Array.prototype.slice.call(tbody.querySelectorAll('tr'))
            .filter(function(tr){return !tr.classList.contains('row-empty') && tr.id!=='noMatchRow';});
        }
        function updateCount(visible,total,querying){
          if(!countBadge) return;
          if(querying && total>0){
            countBadge.style.display='';
            countBadge.textContent=visible+'/'+total;
          }else{
            countBadge.style.display='none';
          }
        }
        function filterRows(query){
          var q=(query||'').toLowerCase();
          var rows=getRows(); var visible=0;
          rows.forEach(function(tr){
            var order=(tr.getAttribute('data-order')||'').toLowerCase();
            var match=(q==='') || order.indexOf(q)!==-1;
            tr.style.display=match?'':'none';
            if(match) visible++;
          });
          if(noMatchRow){
            noMatchRow.style.display=(visible===0 && rows.length>0 && q!=='')?'':'none';
          }
          updateCount(visible,rows.length,q!=='');
        }

        input.addEventListener('input',function(e){ filterRows(e.target.value); });
        clearBtn.addEventListener('click',function(){ input.value=''; filterRows(''); input.focus(); });

        document.addEventListener('keydown',function(e){
          var tag=(document.activeElement&&document.activeElement.tagName||'').toLowerCase();
          if(e.key==='/' && tag!=='input' && tag!=='textarea'){ e.preventDefault(); input.focus(); }
          if(e.key==='Escape'){
            if(document.activeElement===input && input.value){ input.value=''; filterRows(''); }
            else if(document.activeElement===input){ input.blur(); }
          }
        });

        filterRows('');
      });
    })();
  </script>
{% endblock %}

